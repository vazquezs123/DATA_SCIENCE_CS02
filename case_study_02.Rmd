---
title: "CaseStudy02"
author: "Team ..."
date: "April 7, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r }
setwd("C:\\Users\\vazqu\\Documents\\SMU\\data_science\\CaseStudy2_2\\DATA_SCIENCE_CS02")
library(openxlsx)
library(MASS)
library(ggplot2)
library(classInt)
library(hexbin)
attritionData <- read.xlsx("CaseStudy2-data.xlsx")

# recode variables
attritionData$YesTotal <- length(attritionData$Attrition[as.character(attritionData$Attrition) == "Yes"]) # 237
attritionData$NoTotal <- length(attritionData$Attrition[as.character(attritionData$Attrition) == "No"]) # 1233
attritionData$Attrition <- factor(attritionData$Attrition)
attritionData$Gender <- as.factor(attritionData$Gender)
attritionData$Age <- as.integer(attritionData$Age)
attritionData$JobRole <- as.factor(attritionData$JobRole)
attritionData$Education <- as.factor(attritionData$Education)
attritionData$BusinessTravel <- as.factor(attritionData$BusinessTravel)
attritionData$Department <- as.factor(attritionData$Department)
attritionData$EducationField <- as.factor(attritionData$EducationField)
attritionData$Gender <- as.factor(attritionData$Gender)
attritionData$MaritalStatus <- as.factor(attritionData$MaritalStatus)
attritionData$Over18 <- as.factor(attritionData$Over18)
attritionData$OverTime <- as.factor(attritionData$OverTime)
attritionData$MaritalStatus <- as.factor(attritionData$MaritalStatus)
attritionData$MaritalStatus <- as.factor(attritionData$MaritalStatus)
attritionData$MaritalStatus <- as.factor(attritionData$MaritalStatus)
attritionData$AgeGroups <- cut(attritionData$Age, breaks=c(10,20,30,40,50,60))
attritionData$MonthlyIncomeGroup <-cut(attritionData$MonthlyIncome, 
                                       breaks=data.frame(
                                         classIntervals(
                                           attritionData$MonthlyIncome, n=5,
                                           method="quantile")[2])[,1],
                                         include.lowest=T,dig.lab=10)

# derive annual income and classify into income group
attritionData$YearlyIncome <- attritionData$MonthlyIncome*12
attritionData$YearlyIncomeGroup <- cut(attritionData$YearlyIncome, 
                                       breaks=data.frame(
                                         classIntervals(
                                           attritionData$YearlyIncome, n=5,
                                           method="quantile")[2])[,1],
                                         include.lowest=T,dig.lab=10)

attritionFemaleData <- as.data.frame(attritionData[as.character(attritionData$Gender) == "Female",])
attritionData$FemaleTotal <- length(attritionFemaleData)
attritionMaleData <- as.data.frame(attritionData[as.character(attritionData$Gender) == "Male",])
attritionData$MaleTotal <- length(attritionMaleData)
attritionData$YesFemaleTotal <- length(attritionData$Attrition[as.character(attritionData$Attrition) == "Yes" & as.character(attritionData$Gender) == "Female"]) 
attritionData$YesMaleTotal <- length(attritionData$Attrition[as.character(attritionData$Attrition) == "Yes" & as.character(attritionData$Gender) == "Male"])

# generate linear model and run stepwise-selection model method
lm.full <- glm(Attrition ~ DistanceFromHome + Age + MonthlyIncome + Education + HourlyRate + HourlyRate + MonthlyIncome + PerformanceRating + WorkLifeBalance + 
                    JobLevel + NumCompaniesWorked + YearsInCurrentRole + YearsInCurrentRole + YearlyIncomeGroup + DailyRate + JobRole + StockOptionLevel + 
                    YearsSinceLastPromotion + Department + EnvironmentSatisfaction, data = attritionData, family = binomial)
lm.null <- glm(Attrition ~ 1, data = attritionData, family = binomial)

model.aic.stepwise <- step(lm.null, direction="both", trace=1, scope = ~ DistanceFromHome + Age + MonthlyIncome + Education + HourlyRate + HourlyRate + MonthlyIncome +
                             PerformanceRating + WorkLifeBalance + JobLevel + NumCompaniesWorked + YearsInCurrentRole + YearsInCurrentRole + YearlyIncomeGroup + DailyRate +
                             JobRole + StockOptionLevel + YearsSinceLastPromotion + Department + EnvironmentSatisfaction, data = attritionData, family = binomial)

# show histograms of attrition based on different categories
ggplot(attritionData,aes(JobLevel,fill=Attrition))+
    geom_histogram(color="black", stat="count")+
    labs(title="Job Level Attrition Histogram Plot",x="Job Level", y = "Frequency") + facet_grid(. ~ PerformanceRating)

ggplot(attritionData,aes(JobLevel,fill=Attrition))+
    geom_histogram(color="black", stat="count")+
    labs(title="Job Level Attrition Histogram Plot",x="Job Level", y = "Frequency") + 

# heatmap of Job Level related to Monthly Income grouped by Attrition
hexbinplot(JobLevel ~ MonthlyIncome | Attrition, attritionData,
           xlab="Monthly Income", ylab="Job Level", main="Job Level by Monthly Income")

# heatmap of Job Level related to Monthly Income grouped by Attrition
hexbinplot(JobLevel ~ PerformanceRating | Attrition, attritionData,
           xlab="Performance Rating", ylab="Job Level", main="Job Level by Performance Rating")

ggplot(attritionFemaleData, aes(x=Attrition, main="Female Attrition Histogram")) + 
  geom_histogram(color="black", fill="lightpink", stat="count")+
labs(title="Female Attrition Histogram Plot",x="Did they leave?", y = "Frequency")

ggplot(attritionMaleData, aes(x=Attrition, main="Male Attrition Histogram")) + 
  geom_histogram(color="black", fill="lightblue", stat="count")+
labs(title="Male Attrition Histogram Plot",x="Did they leave?", y = "Frequency")

# ~15% women leaving company
length(attritionFemaleData$Attrition[attritionFemaleData$Attrition == "Yes"]) / length(attritionFemaleData$Attrition)
length(attritionFemaleData$Attrition[attritionFemaleData$Attrition == "No"]) / length(attritionFemaleData$Attrition)

# ~17% men leaving company
length(attritionMaleData$Attrition[attritionMaleData$Attrition == "Yes"]) / length(attritionMaleData$Attrition)
length(attritionMaleData$Attrition[attritionMaleData$Attrition == "No"]) / length(attritionMaleData$Attrition)

# create scatter plot based model selection results
# looking at: JobLevel, PerformanceRating, MonthlyIncome, HourlyRate, Department
pairs(~Attrition+JobLevel+PerformanceRating+MonthlyIncome,
      data=attritionData, main="Stepwise Variable Selection Matrix")

pairs(~Attrition+JobLevel+PerformanceRating+MonthlyIncome+HourlyRate+Department,
      data=attritionData, main="Stepwise Variable Selection Matrix")

bin<-hexbin(attritionData$MonthlyIncome, attritionData$Attrition, xbins=50) 
plot(bin, main="Attrion Monthly Income HeatMap", xlab="Monthly Income", ylab="Attrition")

bin<-hexbin(attritionData$Age, attritionData$MonthlyIncome, xbins=50) 
plot(bin, main="Attrion Monthly Income HeatMap")


# heatmap of Distance From Home related to Job Level grouped by Attrition
hexbinplot(DistanceFromHome ~ JobLevel | Attrition, attritionData,
           ylab="Distance from Home", xlab="Job Level")

# heatmap of Job Level related to Hourly Rate grouped by Attrition
hexbinplot(JobLevel ~ HourlyRate | Attrition, attritionData,
           ylab="Job Level", xlab="Hourly Rate")

# heatmap of Education related to Hourly Rate grouped by Attrition
hexbinplot(as.integer(Education) ~ HourlyRate | Attrition, attritionData,
           ylab="Education", xlab="Hourly Rate")

ggplot(attritionData, aes(x = DistanceFromHome, y = Attrition, col=AgeGroups)) +
    geom_bar(stat = "identity", aes(fill=AgeGroups))  +
    labs(title = "Attrition Distance from home Age Group by Gender Plot") + facet_grid(. ~ Gender)
ggsave("Attrition_DistanceFromHome_AgeGroup_Plot.png")

# Look at Attrition and Gender
## Attrition Barplot by Gender
ggplot(attritionData, aes(x = Gender, y = Attrition, col=Attrition)) +
    geom_bar(stat="identity", position="dodge")+
    labs(title = "Attrition Age Group by GenderPlot")
ggsave("Attrition_Age_plot.png", width = 20, height=20)

ggplot(attritionData, aes(x = AgeGroups, y = Attrition)) +
    geom_bar(stat="identity")+
    labs(title = "Attrition Age Group by GenderPlot") + facet_grid(. ~ Gender)
ggsave("Attrition_Age_plot.png", width = 20, height=20)

ggplot(attritionData, aes(x = WorkLifeBalance, y = Attrition, col=JobRole)) +
    geom_bar(stat = "identity", aes(fill = JobRole)) +
    theme(panel.background = element_rect(fill = "#FDF8E2"),
          axis.text.x = element_text(angle = 90, hjust = 1),
          plot.title = element_text(hjust = 0.5)) +
    labs(title = "Attrition Work Life Balance by Work Life Balance Plot") + facet_grid(. ~ Gender)
ggsave("Attrition_WorkLifeBalance_Plot.png", width = 20, height=20)

ggplot(attritionData, aes(x = WorkLifeBalance, y = Attrition, col=JobRole)) +
    geom_bar(stat = "identity", aes(fill = JobRole)) +
    theme(panel.background = element_rect(fill = "#FDF8E2"),
          axis.text.x = element_text(angle = 90, hjust = 1),
          plot.title = element_text(hjust = 0.5)) +
    labs(title = "Attrition Work Life Balance by Work Life Balance Plot") + facet_grid(. ~ Gender)
ggsave("Attrition_WorkLifeBalance_Plot.png", width = 20, height=20)

ggplot(attritionData, aes(x = MonthlyIncomeGroup, y = Attrition, fill=Gender)) +
    geom_bar(stat = "identity", position="dodge") +
    labs(title = "Attrition Monthly Income Plot")
ggsave("Attrition_MonthlyIncome_Plot.png", width = 20, height=20)

ggplot(attritionData, aes(x = MaritalStatus, y = Attrition, fill=factor(JobRole))) +
    geom_bar(stat = "identity", position="dodge") +
    theme(panel.background = element_rect(fill = "#FDF8E2"),
          axis.text.x = element_text(angle = 0, hjust = 1),
          plot.title = element_text(hjust = 0.5)) +
    labs(title = "Attrition Gender Marital Status Plot") 
ggsave("Attrition_Gender_MaritalStatus_Plot.png", width = 20, height=20)

ggplot(attritionData, aes(x = MonthlyIncomeGroup, y = Attrition, col=AgeGroups)) +
    geom_bar(stat = "identity", aes(fill=AgeGroups))  +
    labs(title = "Attrition Monthly Income Age Group by Gender Plot") + facet_grid(. ~ Gender)
ggsave("Attrition_MonthlyIncome_AgeGroup_Plot.png")

ggplot(attritionData, aes(x = DistanceFromHome, y = Attrition, col=AgeGroups)) +
    geom_bar(stat = "identity", aes(fill=AgeGroups))  +
    labs(title = "Attrition Distance from home Age Group by Gender Plot") + facet_grid(. ~ Gender)
ggsave("Attrition_DistanceFromHome_AgeGroup_Plot.png")

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
